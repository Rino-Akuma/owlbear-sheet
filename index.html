<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<style>
body{
  background:#1e1f22;
  color:white;
  font-family:Arial;
}

.top-right-tools{
  position:absolute;
  top:10px;
  right:10px;
  display:flex;
  gap:6px;
}

.top-right-tools button{
  background:#2b2d31;
  color:white;
  border:1px solid #555;
  padding:5px 8px;
  border-radius:6px;
  cursor:pointer;
}

.tabs{
  display:flex;
  gap:6px;
  margin-bottom:8px;
}

.tabs button{
  background:#2b2d31;
  color:white;
  border:1px solid #555;
  padding:6px 10px;
  border-radius:6px;
  cursor:pointer;
}

.tabs button.active{
  background:#3b3f45;
  border-color:#7dd3fc;
}

.tab-content{
  display:none;
  border:1px solid #666;
  border-radius:8px;
  padding:6px;
  background:#24262a;
  min-height:500px;
}
</style>
</head>
<body>

<h3>–õ–∏—Å—Ç –ø–µ—Ä—Å–æ–Ω–∞–∂–∞</h3>

<div class="top-right-tools">
  <button id="langBtn">...</button>
  <button id="exportBtn">üì§ –ï–∫—Å–ø–æ—Ä—Ç</button>
  <button id="importBtn">üì• –Ü–º–ø–æ—Ä—Ç</button>
  <input type="file" id="importFile" accept=".json" style="display:none;">
</div>

<div class="tabs">
  <button data-tab="stats" class="active"></button>
  <button data-tab="weapons"></button>
  <button data-tab="magic"></button>
  <button data-tab="equipment"></button>
  <button data-tab="description"></button>
  <button data-tab="notes"></button>
</div>

<div id="tab_stats" class="tab-content"></div>
<div id="tab_weapons" class="tab-content"></div>
<div id="tab_magic" class="tab-content"></div>
<div id="tab_equipment" class="tab-content"></div>
<div id="tab_description" class="tab-content"></div>
<div id="tab_notes" class="tab-content"></div>

<script>
const buttons = document.querySelectorAll(".tabs button");
const containers = document.querySelectorAll(".tab-content");
const loadedScripts = new Set();
const langBtn = document.getElementById("langBtn");

// === –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –º–æ–≤–∏ ===
function loadLanguage(lang){
  return new Promise((resolve)=>{
    const old = document.getElementById("lang-script");
    if(old) old.remove();

    const s = document.createElement("script");
    s.id = "lang-script";
    s.src = lang === "ua" ? "lang_ua.js" : "lang_ru.js";
    document.body.appendChild(s);

    s.onload = () => {
      localStorage.setItem("lang", lang);
      applyLanguage();
      document.dispatchEvent(new CustomEvent("langChanged", {detail: lang}));
      resolve();
    };
  });
}

// === –ó–∞—Å—Ç–æ—Å—É–≤–∞–Ω–Ω—è –º–æ–≤–∏ –¥–æ –≤–∫–ª–∞–¥–æ–∫ —ñ –∫–Ω–æ–ø–æ–∫ ===
function applyLanguage(){
  if(!window.LANG) return;

  buttons.forEach(btn=>{
    const t = btn.dataset.tab;
    btn.textContent = window.LANG.tabs[t];
  });

  document.getElementById("exportBtn").textContent = window.LANG.buttons.export;
  document.getElementById("importBtn").textContent = window.LANG.buttons.import;

  const current = localStorage.getItem("lang") || "ru";
  langBtn.textContent = current === "ru"
    ? window.LANG.buttons.switchToUA
    : window.LANG.buttons.switchToRU;
}

// === –ü–µ—Ä–µ–º–∏–∫–∞—á –º–æ–≤–∏ ===
langBtn.addEventListener("click", async ()=>{
  const current = localStorage.getItem("lang") || "ru";
  await loadLanguage(current === "ru" ? "ua" : "ru");
});

// === –í–∫–ª–∞–¥–∫–∏ ===
buttons.forEach(btn=>{
  btn.addEventListener("click", async ()=>{
    buttons.forEach(b=>b.classList.remove("active"));
    btn.classList.add("active");

    containers.forEach(c=>c.style.display="none");

    const tab = btn.dataset.tab;
    const container = document.getElementById("tab_"+tab);
    container.style.display="block";

    if(!container.dataset.loaded){
      const html = await fetch(tab + ".html").then(r=>r.text());
      container.innerHTML = html;
      container.dataset.loaded = "true";

      if(!loadedScripts.has(tab)){
        const script = document.createElement("script");
        script.src = tab + ".js";
        document.body.appendChild(script);
        loadedScripts.add(tab);
      }
    }
  });
});

// === –ü–µ—Ä—à–∏–π –∑–∞–ø—É—Å–∫ ===
const savedLang = localStorage.getItem("lang") || "ru";
loadLanguage(savedLang).then(()=>{
  document.querySelector('[data-tab="stats"]').click();
});

/* ===== –Ü–ú–ü–û–†–¢ / –ï–ö–°–ü–û–†–¢ ===== */

document.getElementById("exportBtn").addEventListener("click", ()=>{
  const data = {};
  for(let i=0; i<localStorage.length; i++){
    const key = localStorage.key(i);
    data[key] = localStorage.getItem(key);
  }
  const blob = new Blob([JSON.stringify(data, null, 2)], {type: "application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "owlbear_sheet_backup.json";
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
});

document.getElementById("importBtn").addEventListener("click", ()=>{
  document.getElementById("importFile").click();
});

document.getElementById("importFile").addEventListener("change", (e)=>{
  const file = e.target.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = function(event){
    try{
      const data = JSON.parse(event.target.result);
      localStorage.clear();
      Object.keys(data).forEach(key=>{
        localStorage.setItem(key, data[key]);
      });
      alert("–Ü–º–ø–æ—Ä—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–æ! –ü–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂ —Å—Ç–æ—Ä—ñ–Ω–∫—É.");
    }catch(err){
      alert("–ü–æ–º–∏–ª–∫–∞ —Ñ–∞–π–ª—É! –ü–æ—Ç—Ä—ñ–±–µ–Ω –ø—Ä–∞–≤–∏–ª—å–Ω–∏–π JSON.");
    }
  };
  reader.readAsText(file);
});
</script>

</body>
</html>
